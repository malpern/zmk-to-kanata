# Nick's Keymap Editor Analysis

## Task Checklist

1. Document the Scope and Goals
2. Inventory Keymap Editor Features
3. Analyze Output File Structure
4. Map Features to Output Syntax
5. Identify and Collect Sample Files
6. Review the Keymap Editor Codebase
7. Document Open Questions
8. Assess Parser Requirements
9. Gap Analysis
10. Recommendations and Next Steps

---

## Comparison with Existing Pipeline and Test Suite

### Current Pipeline and Test Suite Overview
- The ZMK-to-Kanata converter pipeline consists of: preprocessor, parser (AST), keymap extractor, behavior transformers, and Kanata output generator.
- The test suite includes unit tests for core modules, integration tests for the CLI, and a set of sample/real-world keymap files (see `examples/` and `tests/fixtures/`).
- Test coverage is high for core parsing, extraction, and transformation logic, with a focus on edge cases and error handling.

### Comparison to Nickanalysis Requirements
| Requirement/Feature                | Pipeline Support | Test Coverage | Notes/Gaps |
|------------------------------------|------------------|---------------|------------|
| Standard ZMK DTS syntax            | Yes              | Yes           |            |
| `keymap` node with multiple layers | Yes              | Yes           |            |
| Layer `bindings` (matrix format)   | Yes              | Yes           |            |
| Top-level `behaviors` node         | Yes              | Yes           |            |
| Top-level `combos` node            | Yes              | Yes           |            |
| Top-level `macros` node            | Yes              | Partial       | Complex/parameterized macros may need more tests |
| Preprocessor macros (`#define`)    | Yes              | Partial       | Some edge cases may not be fully covered         |
| Standard includes                  | Yes              | Yes           |            |
| Custom behaviors                   | Yes              | Partial       | Real-world custom behaviors should be tested     |
| Advanced macros                    | Partial          | Partial       | Some advanced/parameterized macros may not be fully supported/tested |
| Rotary encoders                    | Partial          | Partial       | Test coverage for encoder bindings may be limited|
| Conditional layers                 | Yes (via behaviors) | Partial    | Test coverage for all activation patterns may be limited |
| Mouse keys (`&mkp`)                | No               | No            | Mapping from ZMK mouse key actions to Kanata mouse actions is not implemented; requires development |
| Robust whitespace/comments         | Yes              | Yes           |            |
| Overlays/advanced DTS constructs   | No (not needed)  | N/A           | Not required for Keymap Editor output           |

### Known or Potential Gaps
- **Mouse keys (`&mkp`):** The pipeline does not currently map ZMK mouse key actions to Kanata mouse actions. This feature requires additional development and test coverage.
- **Advanced/parameterized macros:** Some complex macro patterns may not be fully supported or tested.
- **Custom behaviors:** Real-world custom behaviors (as seen in user files) should be explicitly tested.
- **Rotary encoders:** Test coverage for encoder bindings and edge cases may be limited.
- **Preprocessor macros:** Some edge cases (e.g., nested or unusual macro usage) may not be fully covered.
- **Conditional layers:** All activation patterns should be tested to ensure robust support.

---

## Scope and Goals

The goal is to ensure our ZMK-to-Kanata converter can parse and process all ZMK keymap files that can be produced by Nick's Keymap Editor (https://github.com/nickcoutsos/keymap-editor). This does not require supporting every possible ZMK or DTS file, only those generated by the editor. The scope includes:
- All features and constructs the Keymap Editor can output (layers, combos, macros, behaviors, encoders, etc.)
- All file formats and syntactic patterns used by the editor
- Excludes: advanced/custom DTS features not used by the editor, or ZMK extensions not exposed in the UI

Assumptions:
- The Keymap Editor outputs a consistent, well-defined subset of ZMK/DTS
- Future changes to the editor may require periodic updates to our parser/test suite

---

## Feature Inventory

Features supported by Nick's Keymap Editor (from README and Wiki):
- WYSIWYG keymap editing
- Multiple keymap sources (GitHub, clipboard, file system)
- Layers (including conditional layers)
- Combos
- Macros (including parameterized macros)
- Behaviors (creation and re-configuration)
- Rotary encoders
- Multiple keymaps per project
- Auto-generated layouts for most ZMK-supported keyboards
- Dark mode

See: https://github.com/nickcoutsos/keymap-editor/wiki/Features

---

## Findings

### Output File Structure
- Files are in ZMK's Device Tree Source (DTS) format, typically with a `.keymap`, `.dtsi`, or `.zmk` extension.
- The file starts with a `keymap` node, containing one or more `layers` as child nodes.
- Each layer lists its bindings (key assignments) in a matrix format.
- Behaviors, combos, and macros are defined as separate nodes or properties.
- Rotary encoders and other features are included as additional nodes or properties.
- Real-world files may include preprocessor macros (`#define`), custom behaviors, and more complex combos/macros than simple examples.

### Key Observations
- Output is always in standard ZMK DTS format.
- Layers are defined as child nodes under `keymap`, with `bindings` as a matrix.
- Behaviors and combos are defined in their own top-level nodes.
- Macros and advanced behaviors use standard ZMK conventions.
- Real-world files may include preprocessor macros, custom behaviors, and complex combos/macros.

### Feature-to-Syntax Mapping

| Feature         | Output Syntax Example |
|-----------------|----------------------|
| **Layers**      | `layers { layer0 { bindings = <&kp A &kp B ...>; }; ... }` |
| **Combos**      | `combos { combo0 { bindings = <&kp C &kp D>; key-positions = <0 1>; }; ... }` |
| **Macros**      | `macros { macro0 { bindings = <&macro_tap ...>; }; ... }` |
| **Behaviors**   | `behaviors { behavior0 { ... }; ... }` |
| **Rotary Encoders** | `rotary_encoder0 { bindings = <&encoder_cw &encoder_ccw>; };` |
| **Conditional Layers** | `if (condition) { ... }` or via layer activation behaviors |
| **Multiple Keymaps** | Multiple `keymap` nodes or files per project |

*Note: The exact syntax may vary; real samples are needed for confirmation.*

### Codebase Review
- The Keymap Editor is implemented in JavaScript, primarily in the `app` directory.
- Output files are generated using templates and dynamic logic to match ZMK's DTS format.
- Only features supported by the UI are emitted; the codebase does not emit advanced DTS constructs (e.g., overlays, includes beyond standard ones).
- The output is consistent with the features and structure observed in the sample files.

---

## Open Questions

- Are there any undocumented features or output variations in the Keymap Editor?
- How does the editor handle custom behaviors or user-defined macros?
- Are there any edge cases in the output (e.g., empty layers, unusual keycodes)?
- Does the editor ever emit advanced DTS constructs (e.g., includes, overlays)?

---

## Sample Files

- `examples/basic_keymap.dtsi` — layers, simple bindings
- `examples/advanced_features.dtsi` — advanced behaviors, mod-tap, sticky keys
- `examples/complex_keymap.dtsi` — multiple layers, mod-tap, sticky keys, transparent keys
- `tests/fixtures/real_world/card.keymap` — real-world, complex combos, custom behaviors, macros

*To be updated as more files are collected and analyzed.*

---

## Parser Requirements

Based on the analysis above, the parser must support:
- Standard ZMK DTS syntax (nodes, properties, includes, comments)
- `keymap` node with multiple layers, each with a `bindings` property (matrix format)
- Top-level `behaviors`, `combos`, and `macros` nodes with their respective properties
- Support for preprocessor macros (`#define`) and standard includes
- Parsing of custom behaviors and advanced macros as seen in real-world files
- Robust handling of whitespace, comments, and formatting variations
- No need to support overlays, advanced DTS constructs, or features not present in the Keymap Editor output

---

## Gap Analysis

The Keymap Editor output is consistent with standard ZMK DTS format. The parser should be able to handle the features and structure observed in the sample files.

---

## Unsupported ZMK Features in Kanata (macOS Focus)

Some ZMK features present in Keymap Editor outputs cannot be mapped to Kanata, especially on macOS. These should be excluded from translation, and the converter should warn or skip them. Below are known unsupported features:

| ZMK Feature/Behavior         | Example in ZMK/Keymap Editor | Why Not Supported in Kanata (macOS) | Suggested Handling |
|-----------------------------|------------------------------|-------------------------------------|-------------------|
| Bluetooth profile switching  | `&bt BT_PRV`, `&bt BT_NXT`, `&bt BT_CLR` | Kanata does not support Bluetooth profile switching or device management | Warn and ignore   |
| Mouse keys                  | `&mkp LCLK`, `&mkp RCLK`, `&mkp MOVE_UP` | Kanata (esp. on macOS) does not support mouse emulation | Warn and ignore   |
| System controls (bootloader, reset) | `&bootloader`, `&reset` | Kanata cannot trigger firmware/system-level actions | Warn and ignore   |
| Custom ZMK behaviors not mappable | e.g., custom hold-tap, sticky, or macro behaviors with no Kanata equivalent | Kanata may not support all custom/complex behaviors | Warn and ignore or partial translation if possible |
| Advanced macros (timing, tap dance, retro-tap) | e.g., `&td`, `retro-tap` | Kanata macro system is less flexible, especially for timing or tap dance | Warn and ignore or partial translation |
| Layer conditions based on hardware (e.g., sensor, battery) | N/A in Kanata | Kanata does not support hardware-based layer switching | Warn and ignore   |
| RGB/LED controls            | `&rgb_...`, `&led_...`       | Kanata does not support hardware lighting controls | Warn and ignore   |

*This list should be updated as new features or edge cases are discovered.*

---

## Recommendations and Next Steps

1. Implement the parser to handle the features and structure observed in the sample files.
2. Test the parser with a variety of sample files to ensure robustness.
3. Periodically update the parser/test suite as changes to the Keymap Editor are made.
4. Exclude and warn for any ZMK features not supported in Kanata (especially on macOS), as documented above.
5. Implement mapping from ZMK mouse key actions (`&mkp`) to Kanata mouse actions (e.g., `mlft`, `movemouse-up`, etc.), and add corresponding tests and sample files.
6. Consider implementing support for advanced DTS constructs if they become necessary.

---

## Next Steps to Cover Remaining Gap

1. **Implement Mouse Key Mapping**
   - Add logic to map ZMK mouse key actions (`&mkp` and parameters) to Kanata mouse action aliases (e.g., `mlft`, `movemouse-up`, etc.).
   - Update the transformer/model to recognize and convert all supported mouse actions.
   - Add warnings or graceful handling for unmappable mouse actions.
   - Add tests and sample files to verify correct mapping and output.

2. **Expand Advanced Macro Support**
   - Review and extend macro parsing and mapping logic to cover parameterized and complex macros used in Nick's tool.
   - Add tests for edge cases and real-world macro usage.

3. **Enhance Rotary Encoder Support**
   - Ensure rotary encoder bindings are parsed and mapped to Kanata equivalents where possible.
   - Add tests for various encoder scenarios.

4. **Handle Custom Behaviors**
   - Identify custom behaviors present in real-world files.
   - Implement mapping or graceful fallback for these behaviors.
   - Add tests for custom and edge-case behaviors.

5. **Increase Preprocessor Macro Coverage**
   - Add tests for nested, unusual, or edge-case preprocessor macro usage.
   - Ensure the preprocessor step handles all macros used in Nick's tool outputs.

6. **Comprehensive Test Coverage**
   - Expand the test suite to include all features, edge cases, and real-world files from Nick's Keymap Editor.
   - Regularly update tests as the tool or ZMK evolves.

7. **Documentation and User Warnings**
   - Update documentation to reflect new feature support and any remaining limitations.
   - Ensure the converter emits clear warnings for any unsupported or partially supported features.

---

## Feature Matrix for Sample Coverage

| Feature/Option                | Description/Variants                        | Covered by Sample? | Sample File(s)                |
|-------------------------------|---------------------------------------------|--------------------|-------------------------------|
| Layers                        | Multiple layers, naming, ordering           | Yes                | basic_keymap.dtsi, complex_keymap.dtsi |
| Combos                        | Simple, multi-key, with/without layers      | Yes                | card.keymap                   |
| Macros                        | Simple, parameterized, complex sequences    | Partial            | advanced_features.dtsi, card.keymap |
| Behaviors                     | Mod-tap, hold-tap, sticky, custom           | Yes/Partial        | advanced_features.dtsi, card.keymap |
| Rotary Encoders               | Single, multiple, with different actions    | No                 |                               |
| Mouse Keys                    | All actions (move, click, scroll, drag)     | No                 |                               |
| Conditional Layers            | Activation via behaviors, combos, macros    | Partial            | complex_keymap.dtsi           |
| Multiple Keymaps              | Multiple keymap nodes/files per project     | No                 |                               |
| Preprocessor Macros           | #define, nested, unusual usage              | Partial            | card.keymap                   |
| Standard Includes             | All standard ZMK includes                   | Yes                | all .dtsi/.keymap files        |
| Custom Behaviors              | User-defined, edge-case behaviors           | Partial            | card.keymap                   |
| Advanced Macros               | Tap dance, retro-tap, timing                | Partial            | card.keymap                   |
| RGB/LED Controls              | Lighting, effects                           | No                 |                               |
| System Controls               | Bootloader, reset, power                    | No                 |                               |
| Bluetooth Switching           | Profile switching, clearing                 | No                 |                               |
| Edge-case Keycodes            | Unusual or rarely-used keycodes             | Partial            | card.keymap                   |

*Update this matrix as new features or sample files are added. Use it to guide systematic sample generation and ensure comprehensive coverage.*

--- 